var grid={init:function(e){settings.user.grid=e;for(var t=e,r=Math.floor(Math.abs(t[1])),o=Math.floor(Math.abs(t[0])),a=t[1]>=0?1:-1,n=t[0]>=0?1:-1;o>180;)o-=360,settings.user.grid[0]-=360*n;if(0===r)ys=[0,0,1],1===a?(yt=[-1,1,1],yl=[[-1,2],[0,1]]):(yt=[1,-1,-1],yl=[[-2,1],[-1,0]]);else if(89===r)ys=[88,89],yt=[a,a],yl=[[88*a,89.99*a],[89*a]];else{ys=[],yt=[];for(var s=r-1;s<=r+1;s++)ys.push(s),yt.push(a);88===r?yl=[[87*a,89.99*a],[88*a,89*a]]:yl=[[a*(r-1),a*(r+2)],[a*r,a*(r+1)]]}if(0===o)xs=[0,0,1],1===n?(xt=[-1,1,1],xl=[[-1,2],[0,1]]):(xt=[1,-1,-1],xl=[[-2,1],[-1,0]]);else if(179===o)xs=[178,179,179],xt=[n,1,-1],xl=[[178*n,181*n],[179*n,180*n]];else{xs=[],xt=[];for(var l=o-1;l<=o+1;l++)xs.push(l),xt.push(n);xl=[[n*(o-1),n*(o+2)],[n*o,n*(o+1)]]}this.draw()},draw:function(){map.removeLayer(gridLayer),gridVector=new ol.source.Vector({});for(var e=0;e<xl[1].length;e++)this.drawLine([[xl[1][e],yl[0][0]],[xl[1][e],yl[0][1]]]);for(var t=0;t<yl[1].length;t++)this.drawLine([[xl[0][0],yl[1][t]],[xl[0][1],yl[1][t]]]);gridLayer=new ol.layer.Vector({source:gridVector,style:new ol.style.Style({fill:new ol.style.Fill({color:"#0000FF",weight:4}),stroke:new ol.style.Stroke({color:"#0000FF",width:2})})}),map.addLayer(gridLayer)},drawLine:function(e){for(var t=0;t<e.length;t++)e[t]=ol.proj.transform(e[t],"EPSG:4326","EPSG:3857");gridVector.addFeature(new ol.Feature({geometry:new ol.geom.LineString(e)}))}},marker={curDate:null,date:null,get:function(e,t){if(e="undefined"!=typeof e&&e,t="undefined"!=typeof t&&t,marker.date=$("#datepicker").val(),marker.date!==marker.curDate||e){for(var r=0;r<markerLayers.length;r++)map.removeLayer(markerLayers[r]);t||popover.hide(),markerLayers=[],marker.curDate=marker.date;var o="//data.geohashing.info/hash/";$("#showWeek").is(":checked")&&(o+="wk/"),o+=marker.date.split("-").join("/")+".json",$.getJSON(o,function(e){marker.draw(e)}),w30warning.toggle()}},draw:function(e){if("[object Array]"===Object.prototype.toString.call(e))for(var t=0;t<e.length;t++)marker.doDraw(e[t]);else marker.doDraw(e)},doDraw:function(e){var t=new Date(e.date);t.setTime(t.getTime()+60*t.getTimezoneOffset()*1e3);var r=$("#dayOfWeek").is(":checked")?days[t.getDay()]:t.getDate(),o=$("#markerControl .colorPicker.selected").attr("bgcolor"),a=$("#markerControl .colorPicker.selected").attr("fgcolor");s=new ol.source.Vector({});for(var n=0;n<xs.length;n++)if(xs[n]>=30&xt[n]===-1&null!==e.west||xs[n]<30||1===xt[n])for(var l=0;l<ys.length;l++){var i=null;i=xs[n]>=30&xt[n]===-1?new ol.geom.Point(ol.proj.transform([parseFloat(xt[n]*(xs[n]+e.west.lng)),parseFloat(yt[l]*(ys[l]+e.west.lat))],"EPSG:4326","EPSG:3857")):new ol.geom.Point(ol.proj.transform([parseFloat(xt[n]*(xs[n]+e.east.lng)),parseFloat(yt[l]*(ys[l]+e.east.lat))],"EPSG:4326","EPSG:3857")),s.addFeature(new ol.Feature({geometry:i,date:e.date,global:!1}))}markerLayers.push(new ol.layer.Vector({source:s,style:new ol.style.Style({image:new ol.style.Icon({anchor:[13,36],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"/img/marker.php?bg="+o+"&fg="+a+"&text="+r})})})),map.addLayer(markerLayers[markerLayers.length-1]),i=new ol.geom.Point(ol.proj.transform([parseFloat(e.global.lng),parseFloat(e.global.lat)],"EPSG:4326","EPSG:3857")),s=new ol.source.Vector({}),s.addFeature(new ol.Feature({geometry:i,date:e.date,global:!0})),markerLayers.push(new ol.layer.Vector({source:s,style:new ol.style.Style({image:new ol.style.Icon({anchor:[25,72],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"/img/marker.php?bg="+o+"&fg="+a+"&global&text="+r})})})),map.addLayer(markerLayers[markerLayers.length-1])}},date={value:null,change:function(){date.value=$("#datepicker").val(),$("#dateControl .content.datepicker").datepicker("setDate",date.value),marker.get()},refreshMaxDate:function(){$.getJSON("//data.geohashing.info/maxDate",function(e){$("#dateControl .content.datepicker").datepicker("option","maxDate")!==e.maxDate?($("#dateControl .content.datepicker").datepicker("option","maxDate",e.maxDate),marker.get(!0,!0),date.setTimer(10)):date.setTimer(e.nextCheck)})},setTimer:function(e){setTimeout(function(){date.refreshMaxDate()},1e3*e)}};$(window).load(function(){loadmap(),$("#showWeek").change(function(){marker.get(!0)}),$("#datepicker").change(function(){date.change()}),$("#dateControl .content.datepicker").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy-mm-dd",showOtherMonths:!0,selectOtherMonths:!0,firstDay:1,minDate:settings.system.minDate,maxDate:settings.system.maxDate,altField:"#datepicker",defaultDate:settings.system.date,nextText:"&gt;",prevText:"&lt;",hideIfNoPrevNext:!0,onSelect:function(e){marker.get()}}),date.setTimer(settings.refreshMaxDate),$("#inputZoomLevel").change(function(){zoom.change()}),$("#inputZoomLevel").val(settings.user.zoom),$("#zoomControl .slider").slider({value:settings.user.zoom,min:settings.system.minZoom,max:settings.system.maxZoom,slide:function(e,t){$("#inputZoomLevel").val(t.value),zoom.doZoom(t.value)}}),$(window).width()>640&&settings.user.controlsVisible&&controls.show(0),"0,0"!=settings.user.home&&home.set(settings.user.home),"0,0"!=settings.user.grid&&(grid.init(settings.user.grid),marker.get()),$("input[name='dayOf']").change(function(){marker.get(!0,!0)}),$("#markerControl .colorPicker").click(function(e){$(e.target).hasClass("selected")||($("#markerControl .colorPicker").removeClass("selected"),$("#"+e.target.id).addClass("selected"),settings.user.colorSet=$("#"+e.target.id).attr("setid"),marker.get(!0,!0))}),$("#toggleControls").click(function(){controls.toggle()}),$("#openChangelog").click(function(){return greybox.open("changelog"),!1}),$("#openDisclaimer").click(function(){return greybox.open("disclaimer"),!1}),$("#openHelp").click(function(){return greybox.open("help"),!1}),$("#greybox").click(function(){greybox.close()}),$("#greybox>div").click(function(e){e.stopPropagation()}),$("#greybox .closer").click(function(){return greybox.close(),!1}),$(document).keyup(function(e){c=e.keyCode||e.which,27===c&&(greybox.isOpen?greybox.close():popover.hide())}),$("a[href^='http']").attr("target","_blank"),$("input[name=setHomeGrid]").change(function(){geolocation.setTracking(!1)}),$("#redetectHome").click(function(){"nothing"===$("input[name=setHomeGrid]:checked").val()?alert("Please first select what to detect"):geolocation.setTracking(!0)}),$("#controls").niceScroll(),settings.system.showDisclaimer&&greybox.open("disclaimer"),$("#w30warning .close").click(function(){w30warning.hide()}),$(window).on("resize",function(){w30warning.reset()})});