var map,view,settings,ol,xs,xt,xl,ys,yt,yl,gridLayer,gridVector,geolocation,mapLayer,markerLayers=[],content,closer,overlay,days={0:"Su",1:"Mo",2:"Tu",3:"We",4:"Th",5:"Fr",6:"Sa"};function addLiAlpha(b,a){var d=false;$(b+" li").each(function(){if($(this).text().toLowerCase()>$(a).text().toLowerCase()){$(a).insertBefore($(this));d=true;return false}});if(!d){$(a).appendTo($(b))}}var controls={show:function(a){$("#controls").animate({left:"0px"},a);$("#controlsTop").animate({left:"0px",borderBottomRightRadius:0},a);$(".ol-scale-line").animate({left:"328px"},a)},hide:function(){$("#controls").animate({left:"-320px"});$("#controlsTop").animate({left:"-280px",borderBottomRightRadius:5});$(".ol-scale-line").animate({left:"8px"})},toggle:function(){l=$("#controls").css("left");if(l==="0px"){controls.hide()}else{if(l==="-320px"){controls.show()}}}};var date={value:null,change:function(){date.value=$("#datepicker").val();$("#dateControl .content.datepicker").datepicker("setDate",date.value);marker.get()},refreshMaxDate:function(){$.getJSON("/maxDate",function(a){if($("#dateControl .content.datepicker").datepicker("option","maxDate")!==a.maxDate){$("#dateControl .content.datepicker").datepicker("option","maxDate",a.maxDate);marker.get(true,true);date.setTimer(10)}else{date.setTimer(a.nextCheck)}})},setTimer:function(a){setTimeout(function(){date.refreshMaxDate()},a*1000)}};var zoom={value:settings.user.zoom,change:function(){zoom.value=$("#inputZoomLevel").val();$("#zoomControl .slider").slider("value",zoom.value);zoom.doZoom(zoom.value)},doZoom:function(b){var a=ol.animation.zoom({duration:200,resolution:view.getResolution()});map.beforeRender(a);view.setZoom(b)},to:function(e,b,a){var d=ol.animation.zoom({duration:200,resolution:view.getResolution()});map.beforeRender(d);view.setZoom(a);zoom.setCenter(ol.proj.transform([b,e],"EPSG:4326","EPSG:3857"))},setCenter:function(a){var d=map.getSize();var b=parseInt($("#controls").css("width"),10)+parseInt($("#controls").css("left"),10);view.centerOn(a,d,[((d[0]-b)/2)+b,d[1]/2])},reset:function(){zoom.doZoom(settings.user.zoom);zoom.setCenter(ol.proj.transform(home.point,"EPSG:4326","EPSG:3857"))}};var home={layer:null,marker:null,point:null,set:function(a){map.removeLayer(home.layer);home.point=a;settings.user.home=a;home.marker=new ol.source.Vector({});home.marker.addFeature(new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(a,"EPSG:4326","EPSG:3857"))}));home.layer=new ol.layer.Vector({source:home.marker,style:new ol.style.Style({image:new ol.style.Icon({anchor:[16,16],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"/img/marker.png"})})});map.addLayer(home.layer);if(view.getZoom()===2){zoom.to(a[1],a[0],settings.user.zoom)}},distance:function(b){var a=new ol.Sphere(6378137);var d=a.haversineDistance(home.point,b)/1000;return d.toFixed(2)+" km / "+(d*0.621371).toFixed(2)+" miles"}};var marker={curDate:null,date:null,init:function(){var h=home.point;var d=Math.floor(Math.abs(h[1]));var f=Math.floor(Math.abs(h[0]));var e=(h[1]>=0?1:-1);var b=(h[0]>=0?1:-1);if(d===0){ys=[0,0,1];if(e===1){yt=[-1,1,1];yl=[[-1,2],[0,1]]}else{yt=[1,-1,-1];yl=[[-2,1],[-1,0]]}}else{if(d===89){ys=[88,89];yt=[e,e];yl=[[e*88,e*89.99],[e*89]]}else{ys=[];yt=[];for(var g=d-1;g<=d+1;g++){ys.push(g);yt.push(e)}if(d===88){yl=[[e*87,e*89.99],[e*88,e*89]]}else{yl=[[e*(d-1),e*(d+2)],[e*d,e*(d+1)]]}}}if(f===0){xs=[0,0,1];if(b===1){xt=[-1,1,1];xl=[[-1,2],[0,1]]}else{xt=[1,-1,-1];xl=[[-2,1],[-1,0]]}}else{if(f===179){xs=[178,179,179];xt=[b,1,-1];xl=[[b*178,b*181],[b*179,b*180]]}else{xs=[];xt=[];for(var a=f-1;a<=f+1;a++){xs.push(a);xt.push(b)}xl=[[b*(f-1),b*(f+2)],[b*f,b*(f+1)]]}}marker.drawGrid()},get:function(e,a){e=typeof e!=="undefined"?e:false;a=typeof a!=="undefined"?a:false;marker.date=$("#datepicker").val();if(marker.date!==marker.curDate||e){for(var d=0;d<markerLayers.length;d++){map.removeLayer(markerLayers[d])}if(!a){popover.hide()}markerLayers=[];marker.curDate=marker.date;var b="/hash/";if($("#showWeek").is(":checked")){b+="wk/"}b+=marker.date.split("-").join("/")+".json";$.getJSON(b,function(f){marker.draw(f)})}},draw:function(b){if(Object.prototype.toString.call(b)==="[object Array]"){for(var a=0;a<b.length;a++){marker.doDraw(b[a])}}else{marker.doDraw(b)}},doDraw:function(f){var e=new Date(f.date);e.setTime(e.getTime()+e.getTimezoneOffset()*60*1000);var d=$("#dayOfWeek").is(":checked")?days[e.getDay()]:e.getDate();var g=$("#markerControl .colorPicker.selected").attr("bgcolor");var h=$("#markerControl .colorPicker.selected").attr("fgcolor");s=new ol.source.Vector({});for(var b=0;b<xs.length;b++){if((xs[b]>=30&xt[b]===-1&f.west!==null)||xs[b]<30||xt[b]===1){for(var i=0;i<ys.length;i++){var a=null;if(xs[b]>=30&xt[b]===-1){a=new ol.geom.Point(ol.proj.transform([parseFloat(xt[b]*(xs[b]+f.west.lng)),parseFloat(yt[i]*(ys[i]+f.west.lat))],"EPSG:4326","EPSG:3857"))}else{a=new ol.geom.Point(ol.proj.transform([parseFloat(xt[b]*(xs[b]+f.east.lng)),parseFloat(yt[i]*(ys[i]+f.east.lat))],"EPSG:4326","EPSG:3857"))}s.addFeature(new ol.Feature({geometry:a,date:f.date,global:false}))}}}markerLayers.push(new ol.layer.Vector({source:s,style:new ol.style.Style({image:new ol.style.Icon({anchor:[13,36],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"/img/marker.php?bg="+g+"&fg="+h+"&text="+d})})}));map.addLayer(markerLayers[markerLayers.length-1]);a=new ol.geom.Point(ol.proj.transform([parseFloat(f.global.lng),parseFloat(f.global.lat)],"EPSG:4326","EPSG:3857"));s=new ol.source.Vector({});s.addFeature(new ol.Feature({geometry:a,date:f.date,global:true}));markerLayers.push(new ol.layer.Vector({source:s,style:new ol.style.Style({image:new ol.style.Icon({anchor:[25,72],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"/img/marker.php?bg="+g+"&fg="+h+"&global&text="+d})})}));map.addLayer(markerLayers[markerLayers.length-1])},drawGrid:function(){map.removeLayer(gridLayer);gridVector=new ol.source.Vector({});for(var a=0;a<xl[1].length;a++){marker.drawLine([[xl[1][a],yl[0][0]],[xl[1][a],yl[0][1]]])}for(var b=0;b<yl[1].length;b++){marker.drawLine([[xl[0][0],yl[1][b]],[xl[0][1],yl[1][b]]])}gridLayer=new ol.layer.Vector({source:gridVector,style:new ol.style.Style({fill:new ol.style.Fill({color:"#0000FF",weight:4}),stroke:new ol.style.Stroke({color:"#0000FF",width:2})})});map.addLayer(gridLayer)},drawLine:function(b){for(var a=0;a<b.length;a++){b[a]=ol.proj.transform(b[a],"EPSG:4326","EPSG:3857")}gridVector.addFeature(new ol.Feature({geometry:new ol.geom.LineString(b)}))}};popover={lat:null,lng:null,coordinates:null,feature:null,geoName:function(){$.getJSON("/geoName/?lat="+this.lat+"&lng="+this.lng,function(a){$("#geoName").html(a.geoName)})},show:function(d){this.feature=d;this.coordinates=ol.proj.transform(d.getGeometry().getCoordinates(),"EPSG:3857","EPSG:4326");this.lng=this.coordinates[0];this.lat=this.coordinates[1];this.geoName();if(this.feature.get("global")){$("#popup").addClass("global");var b="Globalhash "+d.get("date");var e="global";var g=this.feature.get("date")+"_global"}else{$("#popup").removeClass("global");var a=this.lng.toString().split(".")[0];var f=this.lat.toString().split(".")[0];var e=f+","+a;var b="Geohash "+this.feature.get("date")+" "+f+" "+a;var g=this.feature.get("date")+"_"+f+"_"+a}content.html("<strong>"+b+'</strong> <button onclick="window.open(&quot;http://wiki.xkcd.com/geohashing/'+g+'&quot;)">Meetup</button><br />'+this.lat.toFixed(8)+", "+this.lng.toFixed(8)+' <button onclick="zoom.to('+this.lat+","+this.lng+', 15)">Zoom in</button><br /><span id="geoName"><span style="color:silver;font-style:italic">[A location name should appear here]</span></span><br/>'+home.distance(this.coordinates)+'<br/><button onclick="window.open(&quot;/hash/'+this.feature.get("date").split("-").join("/")+"/"+e+'.gpx&quot;)">GPX</button> <button onclick="window.open(&quot;http://geo.crox.net/poster/'+g+'&quot;)">Poster</button> <button onclick="window.open(&quot;http://www.geocaching.com/seek/nearest.aspx?origin_lat='+this.lat+"&amp;origin_long="+this.lng+'&quot;)">Nearby geocaches</button><button onclick="window.open(&quot;https://maps.google.com/?q='+this.lat+","+this.lng+'&quot;)">Google Maps</button>');overlay.setPosition(this.feature.getGeometry().getCoordinates())},hide:function(){overlay.setPosition(undefined)}};loadmap=function(){content=$("#popup-content");closer=$("#popup-closer");overlay=new ol.Overlay({element:document.getElementById("popup"),autoPan:true,autoPanAnimation:{duration:250}});closer.click(function(){overlay.setPosition(undefined);closer.blur();return false});var d=(settings.user.center!="0,0")?settings.user.zoom:2;view=new ol.View({center:ol.proj.transform(settings.user.center,"EPSG:4326","EPSG:3857"),minZoom:settings.system.minZoom,zoom:d,maxZoom:settings.system.maxZoom,rotation:0,projection:"EPSG:3857"});geolocation=new ol.Geolocation({projection:view.getProjection()});if(settings.user.center=="0,0"){geolocation.setTracking(true)}geolocation.on("change",function(h){zoom.setCenter(geolocation.getPosition());home.set(ol.proj.transform(geolocation.getPosition(),"EPSG:3857","EPSG:4326"));geolocation.setTracking(false);marker.init();marker.get(true)});var b={map:{source:new ol.source.OSM(),name:"OpenStreetMap"},hyb:{source:new ol.source.BingMaps({key:settings.system.bingKey,imagerySet:"AerialWithLabels"}),name:"Bing maps (Hybrid)"},sat:{source:new ol.source.BingMaps({key:settings.system.bingKey,imagerySet:"Aerial"}),name:"Bing maps (Satellite)"}};mapLayer={list:{},current:settings.user.type,register:function(j,i,h){this.list[j]=i;addLiAlpha("#mapControl","<li onclick=\"javascript:mapLayer.load('"+j+'\')"><input type="radio" name="map" onchange="javascript:mapLayer.load(\''+j+'\')" id="map_'+j+'" '+((this.current===j)?'checked="checked"':"")+'/> <label for="map_'+j+'">'+h+"</label></li>")},load:function(h){if(h!==this.current){this.list[h].setVisible(true);this.list[this.current].setVisible(false);this.current=h;$("#map_"+h).prop("checked",true)}}};var g=[];for(var e in b){var f=new ol.layer.Tile({source:b[e].source,visible:(mapLayer.current===e)});mapLayer.register(e,f,b[e].name);g.push(f)}var a=new ol.layer.Group({layers:g});if(navigator.userAgent.match(/Twitter for iP/i)){renderer="dom";$(window).resize(function(){$("#map").width($(window).width());$("#map").height($(window).height());map.updateSize()})}else{renderer=["canvas","dom","webgl"]}map=new ol.Map({target:document.getElementById("map"),layers:[a],view:view,controls:[new ol.control.ScaleLine(),new ol.control.Attribution({collapsible:false})],interactions:ol.interaction.defaults({rotate:false,altShiftDragRotate:false,pinchRotate:false}),overlays:[overlay],renderer:renderer});map.on("moveend",function(){$("#inputZoomLevel").val(view.getZoom());zoom.change()});map.on("singleclick",function(h){var i=map.forEachFeatureAtPixel(h.pixel,function(k,j){return k});if(typeof i!=="undefined"&&i.get("date")){popover.show(i)}else{home.set(ol.proj.transform(h.coordinate,"EPSG:3857","EPSG:4326"));marker.init();marker.get(true)}});map.on("pointermove",function(h){var i=map.forEachFeatureAtPixel(h.pixel,function(k,j){return k.get("date")});map.getTargetElement().style.cursor=i?"pointer":""})};var greybox={isOpen:false,open:function(a){$.getJSON("/text/"+a,function(b){$("#greybox .title").html(b.title);$("#greybox .content").html(b.content);$("#greybox").fadeIn();$("#greybox div").slideDown();$("#greybox .content").scrollTop(0);greybox.isOpen=true});return false},close:function(){$("#greybox>div").slideUp();$("#greybox").fadeOut();$("#greybox .closer").blur();greybox.isOpen=false}};$(window).load(function(){loadmap();$("#showWeek").change(function(){marker.get(true)});$("#datepicker").change(function(){date.change()});$("#dateControl .content.datepicker").datepicker({changeMonth:true,changeYear:true,dateFormat:"yy-mm-dd",showOtherMonths:true,selectOtherMonths:true,firstDay:1,minDate:settings.system.minDate,maxDate:settings.system.maxDate,altField:"#datepicker",defaultDate:settings.system.date,nextText:"&gt;",prevText:"&lt;",hideIfNoPrevNext:true,onSelect:function(a){marker.get()}});date.setTimer(settings.refreshMaxDate);$("#inputZoomLevel").change(function(){zoom.change()});$("#inputZoomLevel").val(settings.user.zoom);$("#zoomControl .slider").slider({value:settings.user.zoom,min:settings.system.minZoom,max:settings.system.maxZoom,slide:function(a,b){$("#inputZoomLevel").val(b.value);zoom.doZoom(b.value)}});if($(window).width()>640&settings.user.controlsVisible){controls.show(0)}if(settings.user.center!="0,0"){home.set(settings.user.center);marker.init();marker.get()}$("input[name='dayOf']").change(function(){marker.get(true,true)});$("#markerControl .colorPicker").click(function(a){if(!$(a.target).hasClass("selected")){$("#markerControl .colorPicker").removeClass("selected");$("#"+a.target.id).addClass("selected");settings.user.colorSet=$("#"+a.target.id).attr("setid");marker.get(true,true)}});$("#openChangelog").click(function(){greybox.open("changelog");return false});$("#greybox").click(function(){greybox.close()});$("#greybox>div").click(function(a){a.stopPropagation()});$("#greybox .closer").click(function(){greybox.close();return false});$(document).keyup(function(a){c=a.keyCode||a.which;if(c===27){if(greybox.isOpen){greybox.close()}else{popover.hide()}}});$("a[href^='http']").attr("target","_blank")});