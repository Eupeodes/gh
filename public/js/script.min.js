var map,view,settings,ol,xs,xt,xl,ys,yt,yl,gridLayer,gridVector,geolocation,mapLayer;var markerLayers=[];var content,closer,overlay;function addLiAlpha(b,a){var c=false;$(b+" li").each(function(){if($(this).text().toLowerCase()>$(a).text().toLowerCase()){$(a).insertBefore($(this));c=true;return false}});if(!c){$(a).appendTo($(b))}}var controls={show:function(a){$("#controls").animate({left:"0px"},a);$("#controlsTop").animate({left:"0px",borderBottomRightRadius:0},a);$(".ol-scale-line").animate({left:"328px"},a)},hide:function(){$("#controls").animate({left:"-320px"});$("#controlsTop").animate({left:"-280px",borderBottomRightRadius:5});$(".ol-scale-line").animate({left:"8px"})},toggle:function(){l=$("#controls").css("left");if(l==="0px"){controls.hide()}else{if(l==="-320px"){controls.show()}}}};var date={value:null,change:function(){date.value=$("#datepicker").val();$("#dateControl .content.datepicker").datepicker("setDate",date.value);marker.get()},refreshMaxDate:function(){$.getJSON("/maxDate",function(a){if($("#dateControl .content.datepicker").datepicker("option","maxDate")!==a.maxDate){$("#dateControl .content.datepicker").datepicker("option","maxDate",a.maxDate);marker.get(true,true);date.setTimer(10)}else{date.setTimer(a.nextCheck)}})},setTimer:function(a){setTimeout(function(){date.refreshMaxDate()},a*1000)}};var zoom={value:settings.zoom,change:function(){zoom.value=$("#inputZoomLevel").val();$("#zoomControl .slider").slider("value",zoom.value);zoom.doZoom(zoom.value)},doZoom:function(b){var a=ol.animation.zoom({duration:200,resolution:view.getResolution()});map.beforeRender(a);view.setZoom(b)},to:function(c,a){var b=ol.animation.zoom({duration:200,resolution:view.getResolution()});map.beforeRender(b);view.setZoom(15);zoom.setCenter(ol.proj.transform([a,c],"EPSG:4326","EPSG:3857"))},setCenter:function(a){var c=map.getSize();var b=parseInt($("#controls").css("width"),10)+parseInt($("#controls").css("left"),10);view.centerOn(a,c,[((c[0]-b)/2)+b,c[1]/2])},reset:function(){zoom.doZoom(settings.zoom);zoom.setCenter(ol.proj.transform(home.point,"EPSG:4326","EPSG:3857"))}};var home={layer:null,marker:null,point:null,set:function(a){map.removeLayer(home.layer);home.point=a;home.marker=new ol.source.Vector({});home.marker.addFeature(new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(a,"EPSG:4326","EPSG:3857"))}));home.layer=new ol.layer.Vector({source:home.marker,style:new ol.style.Style({image:new ol.style.Icon({anchor:[16,16],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"/img/marker.png"})})});map.addLayer(home.layer)},distance:function(b){var a=new ol.Sphere(6378137);var c=a.haversineDistance(home.point,b)/1000;return c.toFixed(2)+" km / "+(c*0.621371).toFixed(2)+" miles"}};var marker={curDate:null,date:null,init:function(){var h=home.point;var d=Math.floor(Math.abs(h[1]));var f=Math.floor(Math.abs(h[0]));var e=(h[1]>=0?1:-1);var b=(h[0]>=0?1:-1);if(d===0){ys=[0,0,1];if(e===1){yt=[-1,1,1];yl=[[-1,2],[0,1]]}else{yt=[1,-1,-1];yl=[[-2,1],[-1,0]]}}else{if(d===89){ys=[88,89];yt=[e,e];yl=[[e*88,e*89.99],[e*89]]}else{ys=[];yt=[];for(var g=d-1;g<=d+1;g++){ys.push(g);yt.push(e)}if(d===88){yl=[[e*87,e*89.99],[e*88,e*89]]}else{yl=[[e*(d-1),e*(d+2)],[e*d,e*(d+1)]]}}}if(f===0){xs=[0,0,1];if(b===1){xt=[-1,1,1];xl=[[-1,2],[0,1]]}else{xt=[1,-1,-1];xl=[[-2,1],[-1,0]]}}else{if(f===179){xs=[178,179,179];xt=[b,1,-1];xl=[[b*178,b*181],[b*179,b*180]]}else{xs=[];xt=[];for(var a=f-1;a<=f+1;a++){xs.push(a);xt.push(b)}xl=[[b*(f-1),b*(f+2)],[b*f,b*(f+1)]]}}marker.drawGrid()},get:function(d,c){d=typeof d!=="undefined"?d:false;c=typeof d!=="undefined"?c:false;marker.date=$("#datepicker").val();if(marker.date!==marker.curDate||d){for(var b=0;b<markerLayers.length;b++){map.removeLayer(markerLayers[b])}if(!c){overlay.setPosition(undefined)}markerLayers=[];marker.curDate=marker.date;var a="/hash/";if($("#showWeek").is(":checked")){a+="wk/"}a+=marker.date.split("-").join("/")+".json";$.getJSON(a,function(e){marker.draw(e)})}},draw:function(b){if(Object.prototype.toString.call(b)==="[object Array]"){for(var a=0;a<b.length;a++){marker.doDraw(b[a])}}else{marker.doDraw(b)}},doDraw:function(e){var d=e.date;var c=parseInt(d.substring(8,10));s=new ol.source.Vector({});for(var b=0;b<xs.length;b++){if((xs[b]>=30&xt[b]===-1&e.west!==null)||xs[b]<30||xt[b]===1){for(var f=0;f<ys.length;f++){var a=null;if(xs[b]>=30&xt[b]===-1){a=new ol.geom.Point(ol.proj.transform([parseFloat(xt[b]*(xs[b]+e.west.lng)),parseFloat(yt[f]*(ys[f]+e.west.lat))],"EPSG:4326","EPSG:3857"))}else{a=new ol.geom.Point(ol.proj.transform([parseFloat(xt[b]*(xs[b]+e.east.lng)),parseFloat(yt[f]*(ys[f]+e.east.lat))],"EPSG:4326","EPSG:3857"))}s.addFeature(new ol.Feature({geometry:a,date:e.date,global:false}))}}}markerLayers.push(new ol.layer.Vector({source:s,style:new ol.style.Style({image:new ol.style.Icon({anchor:[9,34],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"/img/marker/"+c+".png"})})}));map.addLayer(markerLayers[markerLayers.length-1]);a=new ol.geom.Point(ol.proj.transform([parseFloat(e.global.lng),parseFloat(e.global.lat)],"EPSG:4326","EPSG:3857"));s=new ol.source.Vector({});s.addFeature(new ol.Feature({geometry:a,date:e.date,global:true}));markerLayers.push(new ol.layer.Vector({source:s,style:new ol.style.Style({image:new ol.style.Icon({anchor:[21,80],anchorXUnits:"pixels",anchorYUnits:"pixels",src:"/img/marker/global_"+c+".png"})})}));map.addLayer(markerLayers[markerLayers.length-1])},drawGrid:function(){map.removeLayer(gridLayer);gridVector=new ol.source.Vector({});for(var a=0;a<xl[1].length;a++){marker.drawLine([[xl[1][a],yl[0][0]],[xl[1][a],yl[0][1]]])}for(var b=0;b<yl[1].length;b++){marker.drawLine([[xl[0][0],yl[1][b]],[xl[0][1],yl[1][b]]])}gridLayer=new ol.layer.Vector({source:gridVector,style:new ol.style.Style({fill:new ol.style.Fill({color:"#0000FF",weight:4}),stroke:new ol.style.Stroke({color:"#0000FF",width:2})})});map.addLayer(gridLayer)},drawLine:function(b){for(var a=0;a<b.length;a++){b[a]=ol.proj.transform(b[a],"EPSG:4326","EPSG:3857")}gridVector.addFeature(new ol.Feature({geometry:new ol.geom.LineString(b)}))}};popover={lat:null,lng:null,coordinates:null,feature:null,geoName:function(){$.getJSON("/geoName/?lat="+this.lat+"&lng="+this.lng,function(a){$("#geoName").html(a.geoName)})},show:function(c){this.feature=c;this.coordinates=ol.proj.transform(c.getGeometry().getCoordinates(),"EPSG:3857","EPSG:4326");this.lng=this.coordinates[0];this.lat=this.coordinates[1];this.geoName();if(this.feature.get("global")){$("#popup").addClass("global");var b="Globalhash "+c.get("date");var d="global";var f=this.feature.get("date")+"_global"}else{$("#popup").removeClass("global");var a=this.lng.toString().split(".")[0];var e=this.lat.toString().split(".")[0];var d=e+","+a;var b="Geohash "+this.feature.get("date")+" "+e+" "+a;var f=this.feature.get("date")+"_"+e+"_"+a}content.html("<strong>"+b+'</strong> <button onclick="window.open(&quot;http://wiki.xkcd.com/geohashing/'+f+'&quot;)">Meetup</button><br />'+this.lat.toFixed(8)+", "+this.lng.toFixed(8)+' <button onclick="zoom.to('+this.lat+","+this.lng+')">Zoom in</button><br /><span id="geoName"><span style="color:silver;font-style:italic">[A location name should appear here]</span></span><br/>'+home.distance(this.coordinates)+'<br/><button onclick="window.open(&quot;/hash/'+this.feature.get("date").split("-").join("/")+"/"+d+'.gpx&quot;)">GPX</button> <button onclick="window.open(&quot;http://geo.crox.net/poster/'+f+'&quot;)">Poster</button> <button onclick="window.open(&quot;http://www.geocaching.com/seek/nearest.aspx?origin_lat='+this.lat+"&amp;origin_long="+this.lng+'&quot;)">Nearby geocaches</button><button onclick="window.open(&quot;https://maps.google.com/?q='+this.lat+","+this.lng+'&quot;)">Google Maps</button>');overlay.setPosition(this.feature.getGeometry().getCoordinates())}};loadmap=function(){content=$("#popup-content");closer=$("#popup-closer");overlay=new ol.Overlay({element:document.getElementById("popup"),autoPan:true,autoPanAnimation:{duration:250}});closer.click(function(){overlay.setPosition(undefined);closer.blur();return false});view=new ol.View({center:ol.proj.transform(settings.center,"EPSG:4326","EPSG:3857"),minZoom:settings.minZoom,zoom:settings.zoom,maxZoom:settings.maxZoom,rotation:0});geolocation=new ol.Geolocation({projection:view.getProjection()});if(settings.center=="0,0"){geolocation.setTracking(true)}geolocation.on("change",function(f){zoom.setCenter(geolocation.getPosition());home.set(ol.proj.transform(geolocation.getPosition(),"EPSG:3857","EPSG:4326"));geolocation.setTracking(false);marker.init();marker.get(true)});var b={bing_hybrid:{source:new ol.source.BingMaps({key:"AnPs-A1HdnHQ9YOEsBuVSHJQeDpQTMXaxibqQk4Z3rGIocGm1lp6gdf5qvB5-oxk",imagerySet:"AerialWithLabels"}),name:"Bing maps (Hybrid)"},bing_sat:{source:new ol.source.BingMaps({key:"AnPs-A1HdnHQ9YOEsBuVSHJQeDpQTMXaxibqQk4Z3rGIocGm1lp6gdf5qvB5-oxk",imagerySet:"Aerial"}),name:"Bing maps (Satellite)"},osm:{source:new ol.source.OSM(),name:"OpenStreetMap"}};mapLayer={list:{},current:"osm",register:function(h,g,f){this.list[h]=g;addLiAlpha("#mapControl","<li onclick=\"javascript:mapLayer.load('"+h+'\')"><input type="radio" name="map" onchange="javascript:mapLayer.load(\''+h+'\')" id="map_'+h+'" '+((this.current===h)?'checked="checked"':"")+'/> <label for="map_'+h+'">'+f+"</label></li>")},load:function(f){if(f!==this.current){this.list[f].setVisible(true);this.list[this.current].setVisible(false);this.current=f;$("#map_"+f).prop("checked",true)}}};var e=[];for(var c in b){var d=new ol.layer.Tile({source:b[c].source,visible:(mapLayer.current===c)});mapLayer.register(c,d,b[c].name);e.push(d)}var a=new ol.layer.Group({layers:e});map=new ol.Map({target:document.getElementById("map"),layers:[a],view:view,controls:[new ol.control.ScaleLine(),new ol.control.Attribution({collapsible:false})],interactions:ol.interaction.defaults({rotate:false,altShiftDragRotate:false,pinchRotate:false}),overlays:[overlay]});map.on("moveend",function(){$("#inputZoomLevel").val(view.getZoom());zoom.change()});map.on("singleclick",function(f){var g=map.forEachFeatureAtPixel(f.pixel,function(i,h){return i});if(typeof g!=="undefined"&&g.get("date")){popover.show(g)}else{home.set(ol.proj.transform(f.coordinate,"EPSG:3857","EPSG:4326"));marker.init();marker.get(true)}});map.on("pointermove",function(f){var g=map.forEachFeatureAtPixel(f.pixel,function(i,h){return i.get("date")});map.getTargetElement().style.cursor=g?"pointer":""})};$(function(){loadmap();$("#showWeek").change(function(){marker.get(true)});$("#datepicker").change(function(){date.change()});$("#dateControl .content.datepicker").datepicker({changeMonth:true,changeYear:true,dateFormat:"yy-mm-dd",showOtherMonths:true,selectOtherMonths:true,firstDay:1,minDate:settings.minDate,maxDate:settings.maxDate,altField:"#datepicker",defaultDate:settings.date,nextText:"&gt;",prevText:"&lt;",hideIfNoPrevNext:true,onSelect:function(a){marker.get()}});date.setTimer(settings.refreshMaxDate);$("#inputZoomLevel").change(function(){zoom.change()});$("#inputZoomLevel").val(settings.zoom);$("#zoomControl .slider").slider({value:settings.zoom,min:settings.minZoom,max:settings.maxZoom,slide:function(a,b){$("#inputZoomLevel").val(b.value);zoom.doZoom(b.value)}});if($(window).width()>640&settings.controlsVisible){controls.show(0)}if(settings.center!="0,0"){home.set(settings.center);marker.init();marker.get()}});